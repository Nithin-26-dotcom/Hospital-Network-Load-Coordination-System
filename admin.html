<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City-Wide Ambulance Monitor (Admin)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f2f5;
        }

        header {
            background-color: #343a40;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        #map-container {
            flex: 1;
            position: relative;
            border-bottom: 2px solid #ddd;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #logs-container {
            height: 35%;
            padding: 1rem;
            background-color: white;
            overflow-y: auto;
        }

        h2 {
            margin-top: 0;
            font-size: 1.2rem;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .status-idle {
            color: gray;
            font-weight: bold;
        }

        .status-enroute {
            color: orange;
            font-weight: bold;
        }

        .status-arrived {
            color: green;
            font-weight: bold;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 0.8rem;
        }

        .dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            text-align: center;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-warning {
            background-color: #ffc107;
            color: black;
        }

        .btn-primary {
            background-color: #007bff;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .control-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>

<body>
    <header>
        <h1>City-Wide Ambulance Monitor (Admin)</h1>
    </header>

    <div id="wrapper" style="display: flex; flex: 1; overflow: hidden;">
        <div id="sidebar"
            style="width: 300px; padding: 1rem; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column;">
            <h2>Simulation Controls</h2>
            <div class="control-group">
                <h3>1. Select Hospital</h3>
                <select id="hospitalSelect" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;">
                    <option value="">-- Select Hospital --</option>
                </select>
            </div>

            <div class="control-group">
                <h3>2. Trigger Scenario</h3>
                <button onclick="triggerFailure()" class="btn btn-danger">üî• Hospital Failure</button>
                <button onclick="triggerSurge()" class="btn btn-warning">‚ö†Ô∏è Patient Surge (+Load)</button>
            </div>

            <div class="control-group" style="margin-top: auto;">
                <button onclick="resetSimulation()" class="btn btn-primary">üîÑ Reset Simulation</button>
            </div>

            <h3>Live Stats</h3>
            <div id="stats">
                <p>Offline Hospitals: <span id="statOffline">0</span></p>
                <p>Overloaded: <span id="statOverload">0</span></p>
            </div>
        </div>

        <div id="main-content" style="flex: 1; display: flex; flex-direction: column;">
            <div id="map-container">
                <div id="map"></div>
                <div class="legend">
                    <div><span class="dot" style="background:green;"></span> Hospital (Normal)</div>
                    <div><span class="dot" style="background:orange;"></span> Hospital (High Load)</div>
                    <div><span class="dot" style="background:red;"></span> Hospital (Offline)</div>
                    <div><span class="dot" style="background:blue;"></span> Ambulance (Idle)</div>
                    <div><span class="dot" style="background:#007bff;"></span> Ambulance (Enroute)</div>
                </div>
            </div>

            <div id="logs-container">
                <h2>Live Decision Logs (Read-Only)</h2>
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Ambulance ID</th>
                            <th>Destination Hospital</th>
                            <th>Reason Summary</th>
                            <th>Distance / ETA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Logs will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:3000'; // Make sure this matches your backend

        // Map State
        let map;
        let hospitalMarkers = {};
        let ambulanceMarkers = {};
        let ambulanceRoutes = {};
        let hospitalsData = []; // Static list
        let hospitalStates = {}; // Dynamic state

        // Ambulance Fleet (Mocked clients that query real backend)
        const AMBULANCE_COUNT = 6;
        const AMBULANCES = [];

        // Icons
        const hospitalIconNormal = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/4320/4320371.png', // Green/Normal
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
        });

        const hospitalIconWarning = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/564/564619.png', // Orange/Warning (Placeholder URL)
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
        });

        const hospitalIconError = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1828/1828843.png', // Red/Error
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
        });

        const ambulanceIconIdle = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/263/263058.png',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // Initialize Map
        async function initMap() {
            map = L.map('map').setView([17.40, 78.47], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            await fetchHospitals();
            initAmbulances();

            // Start Loops
            setInterval(updateHospitalStates, 2000); // Poll state every 2s
            setInterval(updateAmbulances, 1000); // Move ambulances
            setInterval(generateDecision, 5000); // New decision every 5s
        }

        async function fetchHospitals() {
            try {
                const res = await fetch(`${API_BASE}/hospitals`);
                hospitalsData = await res.json();

                const select = document.getElementById('hospitalSelect');

                hospitalsData.forEach(h => {
                    // Marker
                    const marker = L.marker([h.latitude, h.longitude], { icon: hospitalIconNormal })
                        .addTo(map)
                        .bindPopup(`<b>${h.name}</b><br>ID: ${h.hospital_id}`);
                    hospitalMarkers[h.hospital_id] = marker;

                    // Dropdown option
                    const opt = document.createElement('option');
                    opt.value = h.hospital_id;
                    opt.textContent = h.name;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error("Error fetching hospitals:", err);
            }
        }

        async function updateHospitalStates() {
            try {
                const res = await fetch(`${API_BASE}/hospitals/state/all`);
                hospitalStates = await res.json();

                let offlineCount = 0;
                let overloadCount = 0;

                Object.values(hospitalStates).forEach(state => {
                    const marker = hospitalMarkers[state.hospital_id];
                    if (!marker) return;

                    // Visualization Logic
                    let icon = hospitalIconNormal;
                    let popupText = `<b>${state.name || 'Hospital'}</b><br>
                                     Beds: ${state.available_beds}<br>
                                     Load: ${state.current_load_score}<br>
                                     Status: ${state.status}`;

                    if (state.status === 'OFFLINE') {
                        icon = hospitalIconError;
                        offlineCount++;
                    } else if (state.current_load_score >= 80 || state.available_beds == 0) {
                        icon = hospitalIconWarning;
                        overloadCount++;
                    }

                    marker.setIcon(icon);
                    marker.setPopupContent(popupText);
                });

                document.getElementById('statOffline').textContent = offlineCount;
                document.getElementById('statOverload').textContent = overloadCount;

            } catch (err) {
                console.error("Error updating states:", err);
            }
        }

        // --- Simulation Controls ---

        async function triggerFailure() {
            const hospitalId = document.getElementById('hospitalSelect').value;
            if (!hospitalId) return alert("Select a hospital first!");

            await fetch(`${API_BASE}/simulation/override`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    hospital_id: hospitalId,
                    status: 'OFFLINE',
                    available_beds: 0,
                    available_icu_beds: 0
                })
            });
            // State update loop will catch the change visually
        }

        async function triggerSurge() {
            const hospitalId = document.getElementById('hospitalSelect').value;
            // If no hospital selected, maybe surge all? For now, require selection.
            if (!hospitalId) return alert("Select a hospital for surge!");

            await fetch(`${API_BASE}/simulation/override`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    hospital_id: hospitalId,
                    current_load_score: 90 // High load
                })
            });
        }

        async function resetSimulation() {
            await fetch(`${API_BASE}/simulation/reset`, { method: 'POST' });
        }


        // --- Ambulance Simulation ---

        function initAmbulances() {
            for (let i = 0; i < AMBULANCE_COUNT; i++) {
                // Random start near center
                const lat = 17.38 + (Math.random() - 0.5) * 0.1;
                const lng = 78.48 + (Math.random() - 0.5) * 0.1;

                AMBULANCES.push({
                    id: `AMB-${100 + i}`,
                    lat: lat,
                    lng: lng,
                    status: 'IDLE', // IDLE, ENROUTE
                    destination: null,
                    progress: 0,
                    routePath: null
                });

                // Create Marker
                const marker = L.marker([lat, lng], { icon: ambulanceIconIdle }).addTo(map)
                    .bindPopup(`<b>${AMBULANCES[i].id}</b><br>Status: IDLE`);

                ambulanceMarkers[AMBULANCES[i].id] = marker;
            }
        }

        function updateAmbulances() {
            AMBULANCES.forEach(amb => {
                if (amb.status === 'ENROUTE' && amb.routePath) {
                    // Move along path
                    if (amb.progress < amb.routePath.length - 1) {
                        amb.progress++;
                        const newPos = amb.routePath[amb.progress]; // [lat, lng]
                        amb.lat = newPos[0];
                        amb.lng = newPos[1];

                        if (ambulanceMarkers[amb.id]) {
                            ambulanceMarkers[amb.id].setLatLng([amb.lat, amb.lng]);
                        }
                    } else {
                        // Arrived
                        amb.status = 'IDLE';
                        amb.destination = null;
                        amb.routePath = null;
                        amb.progress = 0;

                        if (ambulanceRoutes[amb.id]) {
                            map.removeLayer(ambulanceRoutes[amb.id]);
                            delete ambulanceRoutes[amb.id];
                        }
                        if (ambulanceMarkers[amb.id]) {
                            ambulanceMarkers[amb.id].setPopupContent(`<b>${amb.id}</b><br>Status: IDLE`);
                        }
                    }
                }
            });
        }

        async function generateDecision() {
            const idleAmbulances = AMBULANCES.filter(a => a.status === 'IDLE');
            if (idleAmbulances.length === 0) return;

            const amb = idleAmbulances[Math.floor(Math.random() * idleAmbulances.length)];

            // CALL REAL DECISION ENGINE
            try {
                const payload = {
                    request_id: "sim-" + Date.now(),
                    ambulance: {
                        ambulance_id: amb.id,
                        latitude: amb.lat,
                        longitude: amb.lng
                    },
                    patient: {
                        age: 30,
                        gender: 'M',
                        severity_level: 3,
                        requires_icu: Math.random() > 0.7, // Randomly critical
                        symptoms_summary: "Simulated Case"
                    },
                    constraints: {
                        max_distance_km: 20,
                        max_results: 1
                    }
                };

                const res = await fetch(`${API_BASE}/agent/decide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const decision = await res.json();

                if (decision.recommendations && decision.recommendations.length > 0) {
                    const rec = decision.recommendations[0];
                    // Find target hospital coords
                    const targetState = hospitalStates[rec.hospital_id];
                    // Or look in static data if state not yet synced
                    const targetStatic = hospitalsData.find(h => h.hospital_id === rec.hospital_id);
                    const target = targetState || targetStatic;

                    if (!target) return; // Should not happen

                    // Assign
                    amb.status = 'ENROUTE';
                    amb.destination = target;

                    // Fetch Route (OSRM)
                    const routeRes = await fetch(`https://router.project-osrm.org/route/v1/driving/${amb.lng},${amb.lat};${target.longitude},${target.latitude}?overview=full&geometries=geojson`);
                    const routeData = await routeRes.json();

                    if (routeData.routes && routeData.routes.length > 0) {
                        const route = routeData.routes[0];
                        amb.routePath = route.geometry.coordinates.map(c => [c[1], c[0]]);

                        const polyline = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 4, opacity: 0.7 } }).addTo(map);
                        ambulanceRoutes[amb.id] = polyline;

                        addLog(amb.id, target.name, route.distance, route.duration, rec.reasons || ["Decision Engine"]);
                    }
                }
            } catch (e) {
                console.error("Simulation Decision Failed", e);
            }
        }

        function addLog(ambId, hospitalName, distanceMeters, durationSeconds, reasons) {
            const tableBody = document.querySelector('#logsTable tbody');
            const row = document.createElement('tr');

            const distKm = (distanceMeters / 1000).toFixed(1);
            const etaMin = Math.round(durationSeconds / 60);

            row.innerHTML = `
                <td>${new Date().toLocaleTimeString()}</td>
                <td><b>${ambId}</b></td>
                <td>${hospitalName}</td>
                <td>${reasons.join(", ")}</td>
                <td>${distKm} km (~${etaMin} min)</td>
            `;

            tableBody.insertBefore(row, tableBody.firstChild);
            if (tableBody.children.length > 10) tableBody.removeChild(tableBody.lastChild);
        }

        // Start
        window.onload = initMap;
    </script>
</body>

</html>