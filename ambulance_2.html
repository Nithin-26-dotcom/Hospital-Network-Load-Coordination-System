<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ambulance Dispatch Â· Lifecycle</title>

    <!-- Tailwind (clinicalâ€‘focused config) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#0a0e1a',
                        },
                        clinical: {
                            blue: '#2563eb',
                            red: '#dc2626',
                            green: '#16a34a',
                            amber: '#d97706',
                            gray: '#6b7280',
                        }
                    },
                    backgroundImage: {
                        'grid-subtle': 'linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px)',
                    }
                }
            }
        }
    </script>

    <!-- Fonts + Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet Core -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ---------- CLINICAL GRADE â€“ CLEAN, PROFESSIONAL ---------- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0e1a;
            background-image: radial-gradient(circle at 20% 30%, rgba(37, 99, 235, 0.02) 0%, transparent 30%),
                radial-gradient(circle at 80% 70%, rgba(22, 163, 74, 0.02) 0%, transparent 40%);
            background-attachment: fixed;
        }

        /* ----- Custom Scrollbar (subtle) ----- */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        /* ----- Clinical Panel â€“ clean glass ----- */
        .clinical-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 20px -8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .clinical-panel:hover {
            border-color: rgba(37, 99, 235, 0.3);
            box-shadow: 0 12px 24px -10px rgba(37, 99, 235, 0.2);
        }

        /* ----- Input â€“ clean, no glow ----- */
        .input-clinical {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(37, 99, 235, 0.5);
            transition: all 0.2s ease;
            color: #fff;
        }

        .input-clinical:focus {
            border-color: #2563eb;
            border-bottom-width: 2px;
            box-shadow: 0 4px 12px -6px #2563eb;
            outline: none;
            background: rgba(15, 23, 42, 0.8);
        }

        /* ----- Buttons ----- */
        .btn-clinical {
            background: #2563eb;
            color: white;
            font-weight: 500;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-clinical:hover {
            background: #1d4ed8;
        }

        .btn-clinical-outline {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.3);
        }

        .btn-clinical-outline:hover {
            background: #2563eb;
            color: white;
        }

        /* ----- Digital Clock ----- */
        .clinical-clock {
            font-family: 'JetBrains Mono', monospace;
            color: #e2e8f0;
        }

        /* ----- Table Styling (dark, clinical) ----- */
        #resultsTable {
            width: 100%;
            border-collapse: collapse;
        }

        #resultsTable th {
            background: rgba(2, 6, 23, 0.7);
            color: #94a3b8;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        #resultsTable td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            color: #e2e8f0;
            font-size: 0.8rem;
        }

        #resultsTable tbody tr:hover {
            background: rgba(37, 99, 235, 0.06);
        }

        .rank-1 {
            background: rgba(22, 163, 74, 0.1);
            border-left: 3px solid #16a34a;
        }

        /* ----- Map container â€“ original OSM light theme ----- */
        #map {
            border-radius: 0.5rem;
            background: #f8fafc;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ----- Lifecycle view containers ----- */
        .lifecycle-view {
            margin-top: 1.5rem;
        }

        /* ----- Status badge ----- */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.3);
        }
    </style>
</head>

<body
    class="bg-slate-950 text-slate-200 font-sans antialiased min-h-screen flex flex-col relative bg-grid-subtle selection:bg-clinical-blue/30">

    <!-- ========== HEADER â€“ CLEAN CLINICAL (NO BEDS/ICU) ========= -->
    <header class="h-16 border-b border-white/5 bg-slate-950/90 backdrop-blur sticky top-0 z-50 flex-none shadow-md">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <!-- Left: Brand & Status -->
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-clinical-blue/20 rounded-lg flex items-center justify-center border border-clinical-blue/30">
                    <i class="fa-solid fa-ambulance text-clinical-blue text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-semibold tracking-wide text-white flex items-center gap-2">
                        Ambulance Dispatch Interface
                        <span
                            class="text-[10px] font-mono bg-slate-800 px-2 py-0.5 rounded-full text-clinical-blue border border-clinical-blue/30">v2.0</span>
                    </h1>
                    <div class="flex items-center gap-3 text-[10px] font-mono text-slate-400">
                        <span class="flex items-center gap-1">
                            <span class="w-1.5 h-1.5 bg-clinical-green rounded-full"></span>
                            SYSTEM ONLINE
                        </span>
                        <span class="text-slate-600">|</span>
                        <span class="flex items-center gap-1">
                            <i class="fa-solid fa-heart-pulse text-clinical-blue"></i> EMS READY
                        </span>
                    </div>
                </div>
            </div>

            <!-- Right: Clock -->
            <div class="flex flex-col items-end">
                <p class="text-xl font-mono text-white clinical-clock" id="clock">00:00:00</p>
                <p class="text-[9px] text-slate-500 font-mono uppercase">LOCAL TIME</p>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 sm:p-6 scroll-smooth relative z-20">
        <div class="max-w-6xl mx-auto relative z-20">

            <!-- ========== LOGIN SECTION â€“ CLINICAL ========= -->
            <div id="loginSection" class="max-w-md mx-auto mt-10">
                <div class="clinical-panel rounded-2xl overflow-hidden shadow-xl">
                    <div class="bg-slate-900/80 p-8 text-center border-b border-white/5">
                        <div
                            class="w-20 h-20 mx-auto bg-slate-800 rounded-full flex items-center justify-center mb-4 border border-clinical-blue/30">
                            <i class="fa-solid fa-user-astronaut text-3xl text-clinical-blue"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white">Ambulance Login</h2>
                        <p class="text-slate-400 text-xs mt-1 font-mono">Enter credentials to access dispatch</p>
                    </div>

                    <div class="p-8 space-y-5">
                        <div class="space-y-1">
                            <label
                                class="text-[10px] font-medium text-slate-400 uppercase tracking-wide ml-1 flex items-center gap-1">
                                <i class="fa-solid fa-id-card"></i> Username
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-slate-500"><i
                                        class="fa-solid fa-id-badge"></i></span>
                                <input type="text" id="loginUsername" placeholder="Enter Username"
                                    class="input-clinical w-full pl-9 pr-4 py-2.5 rounded-lg text-white placeholder-slate-600 font-mono text-sm">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label
                                class="text-[10px] font-medium text-slate-400 uppercase tracking-wide ml-1 flex items-center gap-1">
                                <i class="fa-solid fa-shield-halbed"></i> Password
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-slate-500"><i
                                        class="fa-solid fa-key"></i></span>
                                <input type="password" id="loginPassword" placeholder="Enter Password"
                                    class="input-clinical w-full pl-9 pr-4 py-2.5 rounded-lg text-white placeholder-slate-600 font-mono">
                            </div>
                        </div>

                        <button onclick="handleLogin()" class="btn-clinical w-full shadow-md">
                            <span>Login</span>
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>

                        <div id="loginMessage" class="text-center text-xs font-mono min-h-[24px]"></div>

                        <div id="registerPrompt" class="hidden pt-4 border-t border-white/10 text-center">
                            <button onclick="showRegister()"
                                class="text-slate-400 hover:text-clinical-blue text-xs transition-colors flex items-center justify-center gap-2 mx-auto">
                                <i class="fa-solid fa-plus-circle"></i> Register New Ambulance
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== REGISTER SECTION â€“ CLINICAL ========= -->
            <div id="registerSection" class="hidden max-w-lg mx-auto mt-10">
                <div class="clinical-panel rounded-2xl overflow-hidden border-l-4 border-l-clinical-blue">
                    <div class="p-5 border-b border-white/5 flex justify-between items-center bg-slate-900/50">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                            <i class="fa-solid fa-truck-medical text-clinical-blue"></i> Register Ambulance
                        </h2>
                        <button onclick="showSection('loginSection')"
                            class="text-slate-400 hover:text-white transition-colors">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <form id="registerForm" onsubmit="handleRegister(event)" class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-medium text-slate-400 uppercase">Username</label>
                                <input type="text" name="username" required
                                    class="input-clinical w-full p-2.5 rounded text-sm">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-medium text-slate-400 uppercase">Password</label>
                                <input type="password" name="password" required
                                    class="input-clinical w-full p-2.5 rounded text-sm">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-medium text-slate-400 uppercase">Registration Number</label>
                            <input type="text" name="registration_number" placeholder="e.g., GVK EMRI" required
                                class="input-clinical w-full p-2.5 rounded text-sm font-mono">
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-medium text-slate-400 uppercase">Organization</label>
                            <input type="text" name="organization" placeholder="e.g., GVK EMRI" required
                                class="input-clinical w-full p-2.5 rounded text-sm">
                        </div>

                        <div class="p-4 bg-slate-900/50 rounded-lg border border-white/5 space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="text-[11px] font-medium text-clinical-blue uppercase tracking-wide">GPS
                                    Coordinates</label>
                                <button type="button" onclick="fillRegisterLocation()"
                                    class="text-xs bg-clinical-blue/10 text-clinical-blue hover:bg-clinical-blue hover:text-white px-3 py-1.5 rounded transition-colors border border-clinical-blue/30 flex items-center gap-1">
                                    <i class="fa-solid fa-satellite-dish"></i> Autoâ€‘Fix
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" step="any" name="latitude" id="reg_lat" placeholder="Latitude"
                                    required class="input-clinical w-full p-2 rounded text-xs font-mono text-center">
                                <input type="number" step="any" name="longitude" id="reg_lng" placeholder="Longitude"
                                    required class="input-clinical w-full p-2 rounded text-xs font-mono text-center">
                            </div>
                        </div>

                        <button type="submit"
                            class="w-full bg-slate-700 hover:bg-clinical-blue text-white font-medium py-2.5 rounded-lg transition-colors flex justify-center items-center gap-2">
                            <i class="fa-solid fa-check-double"></i> Register & Login
                        </button>
                    </form>
                    <div id="registerMessage" class="px-6 pb-6 text-center text-xs font-mono text-clinical-blue"></div>
                </div>
            </div>

            <!-- ========== DASHBOARD SECTION â€“ LIFECYCLE, CLINICAL ========= -->
            <div id="dashboardSection" class="hidden space-y-6 pb-12">

                <!-- ðŸš‘ ASSET IDENTITY CARD (ambulance ID & registration) -->
                <div class="clinical-panel p-5 rounded-xl flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4 z-10 w-full md:w-auto">
                        <div
                            class="w-14 h-14 bg-slate-800/80 rounded-lg flex items-center justify-center border border-clinical-blue/40">
                            <i class="fa-solid fa-truck-medical text-2xl text-white"></i>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-400 uppercase tracking-wide font-medium">Registration /
                                Name</div>
                            <div class="text-2xl font-mono font-semibold text-white" id="displayRegNum">---</div>
                            <div class="text-xs text-slate-500 font-mono mt-1">ID: <span
                                    id="displayAmbulanceId">---</span></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="status-badge" id="displayStatus">IDLE</span>
                        <button onclick="handleLogout()"
                            class="bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1">
                            <i class="fa-solid fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>

                <!-- ðŸ†• ACTIVE RESERVATION PANEL (Dynamic) -->
                <div id="reservation-info-panel"
                    class="hidden clinical-panel p-4 rounded-xl border-l-4 border-l-clinical-green bg-slate-900/40 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
                        <i class="fa-solid fa-hospital-user text-6xl text-white"></i>
                    </div>
                    <div
                        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 relative z-10">
                        <div>
                            <h4
                                class="text-xs font-semibold text-clinical-green uppercase tracking-wide mb-1 flex items-center gap-2">
                                <i class="fa-solid fa-bed-pulse"></i> Active Reservation
                            </h4>
                            <div class="text-lg text-white font-medium flex flex-wrap gap-x-4 gap-y-1">
                                <span id="res-hospital-name">---</span>
                                <span class="text-slate-500 text-sm font-normal">|</span>
                                <span id="res-bed-type"
                                    class="text-sm font-mono bg-slate-800 px-2 rounded text-slate-300 border border-slate-700">---</span>
                            </div>
                            <div class="text-xs text-slate-400 mt-1 font-mono">
                                ID: <span id="res-id">---</span>
                            </div>
                        </div>
                        <div class="text-right w-full sm:w-auto bg-slate-950/50 p-3 rounded-lg border border-white/5">
                            <div class="text-[10px] text-slate-500 uppercase font-medium">Expires In</div>
                            <div id="res-timer" class="text-xl font-mono text-clinical-amber font-bold">--:--</div>
                        </div>
                    </div>
                </div>

                <!-- ========== LIFECYCLE CONTAINER ========= -->
                <div id="lifecycleContainer" class="space-y-6">

                    <!-- STATE: IDLE -->
                    <div id="view-IDLE" class="lifecycle-view clinical-panel rounded-xl overflow-hidden">
                        <div class="bg-slate-900/70 px-5 py-3 border-b border-white/5">
                            <h3 class="font-medium text-white flex items-center gap-2 text-sm">
                                <span class="w-1 h-4 bg-clinical-blue rounded-full"></span>
                                Start New Case
                            </h3>
                        </div>
                        <form id="decisionForm" onsubmit="handleDecisionRequest(event)" class="p-6 space-y-6">
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Patient Details -->
                                <div class="space-y-4">
                                    <h4
                                        class="text-xs font-semibold text-slate-300 flex items-center gap-1 border-b border-white/5 pb-1">
                                        <i class="fa-solid fa-user-injured text-clinical-blue"></i> Patient Details
                                    </h4>
                                    <div class="space-y-1">
                                        <label
                                            class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Age</label>
                                        <input type="number" name="patient_age" required
                                            class="input-clinical w-full p-2.5 rounded-lg text-base font-mono">
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Gender</label>
                                        <select name="patient_gender"
                                            class="input-clinical w-full p-2.5 rounded-lg text-base">
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Severity
                                            Level (1-5)</label>
                                        <input type="number" name="severity_level" min="1" max="5" required
                                            class="input-clinical w-full p-2.5 rounded-lg text-base font-mono">
                                    </div>
                                    <div
                                        class="flex items-center gap-2 p-2 bg-slate-900/30 rounded-lg border border-white/5">
                                        <input type="checkbox" name="requires_icu" id="reqICU"
                                            class="w-4 h-4 rounded border-white/20 bg-slate-700 checked:bg-clinical-blue">
                                        <label for="reqICU" class="text-xs font-medium text-slate-300">Requires
                                            ICU</label>
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Requires
                                            Specialty (Optional)</label>
                                        <input type="text" name="requires_specialty" placeholder="e.g., Cardiology"
                                            class="input-clinical w-full p-2.5 rounded-lg text-sm">
                                    </div>
                                </div>
                                <!-- Location & Constraints -->
                                <div class="space-y-4">
                                    <h4
                                        class="text-xs font-semibold text-slate-300 flex items-center gap-1 border-b border-white/5 pb-1">
                                        <i class="fa-solid fa-location-dot text-clinical-blue"></i> Location &
                                        Constraints
                                    </h4>
                                    <div class="space-y-1">
                                        <label
                                            class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Current
                                            Latitude</label>
                                        <div class="flex gap-2">
                                            <input type="number" step="any" name="latitude" id="currentLat" required
                                                class="input-clinical w-full p-2.5 rounded-lg text-base font-mono flex-1">
                                            <button type="button" onclick="getCurrentLocation()"
                                                class="bg-clinical-blue/10 hover:bg-clinical-blue text-clinical-blue hover:text-white px-3 rounded-lg border border-clinical-blue/30 transition-colors"
                                                title="Use current location">
                                                <i class="fa-solid fa-location-dot"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <label
                                            class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Current
                                            Longitude</label>
                                        <input type="number" step="any" name="longitude" id="currentLng" required
                                            class="input-clinical w-full p-2.5 rounded-lg text-base font-mono">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Max
                                            Distance (km)</label>
                                        <input type="number" name="max_distance_km" value="15" required
                                            class="input-clinical w-full p-2.5 rounded-lg text-base font-mono">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-medium text-slate-400 uppercase tracking-wide">Max
                                            Results</label>
                                        <input type="number" name="max_results" value="5" required
                                            class="input-clinical w-full p-2.5 rounded-lg text-base font-mono">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn-clinical w-full text-sm py-3 mt-2">
                                <i class="fa-solid fa-search-location"></i>
                                Find Best Hospitals
                            </button>
                        </form>
                        <div id="decisionMessage" class="px-6 pb-4 text-center text-xs font-mono"></div>
                    </div>

                    <!-- STATE: CASE_CREATED (Results) -->
                    <div id="view-CASE_CREATED" class="lifecycle-view hidden clinical-panel rounded-xl overflow-hidden">
                        <div class="bg-slate-900/70 px-5 py-3 border-b border-white/5">
                            <h3 class="font-medium text-white flex items-center gap-2 text-sm">
                                <span class="w-1 h-4 bg-clinical-amber rounded-full"></span>
                                Select Destination Hospital
                            </h3>
                        </div>
                        <div class="p-6">
                            <div id="resultsArea">
                                <div class="overflow-x-auto">
                                    <table id="resultsTable" class="w-full">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Hospital</th>
                                                <th>Distance / ETA</th>
                                                <th>Score</th>
                                                <th>Status Snapshot</th>
                                                <th>Reasoning</th>
                                                <th class="text-right">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-white/5"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-center">
                                <button onclick="cancelCase()"
                                    class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                                    <i class="fa-solid fa-ban"></i> Cancel Case
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- STATE: HOSPITAL_SELECTED -->
                    <div id="view-HOSPITAL_SELECTED"
                        class="lifecycle-view hidden clinical-panel rounded-xl overflow-hidden">
                        <div class="bg-slate-900/70 px-5 py-3 border-b border-white/5">
                            <h3 class="font-medium text-white flex items-center gap-2 text-sm">
                                <span class="w-1 h-4 bg-clinical-blue rounded-full"></span>
                                Hospital Selected
                            </h3>
                        </div>
                        <div class="p-6 text-center">
                            <div
                                class="w-16 h-16 mx-auto bg-clinical-blue/20 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-solid fa-check text-3xl text-clinical-blue"></i>
                            </div>
                            <p class="text-lg font-semibold text-white">Destination Confirmed</p>
                            <p class="text-sm text-slate-400 mt-1">Target: <span id="lbl-target-hospital"
                                    class="font-mono text-clinical-blue">---</span></p>
                            <p class="text-xs text-slate-500 mt-2">Prepare for transport.</p>
                            <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
                                <button onclick="updateStatus('EN_ROUTE')"
                                    class="btn-clinical bg-clinical-green hover:bg-clinical-green/90">
                                    <i class="fa-solid fa-route"></i> Start Route
                                </button>
                                <button onclick="cancelCase()"
                                    class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- STATE: EN_ROUTE -->
                    <div id="view-EN_ROUTE" class="lifecycle-view hidden clinical-panel rounded-xl overflow-hidden">
                        <div class="bg-slate-900/70 px-5 py-3 border-b border-white/5">
                            <h3 class="font-medium text-white flex items-center gap-2 text-sm">
                                <span class="w-1 h-4 bg-clinical-amber rounded-full"></span>
                                En Route to Hospital
                            </h3>
                        </div>
                        <div class="p-6">
                            <div id="map" class="w-full h-80 rounded-lg"></div>
                            <div class="mt-6 flex justify-center">
                                <button onclick="updateStatus('ARRIVED')"
                                    class="bg-clinical-amber hover:bg-clinical-amber/90 text-white font-medium py-2.5 px-6 rounded-lg transition-colors flex items-center gap-2">
                                    <i class="fa-solid fa-location-dot"></i> Mark Arrived
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- STATE: ARRIVED -->
                    <div id="view-ARRIVED" class="lifecycle-view hidden clinical-panel rounded-xl overflow-hidden">
                        <div class="bg-slate-900/70 px-5 py-3 border-b border-white/5">
                            <h3 class="font-medium text-white flex items-center gap-2 text-sm">
                                <span class="w-1 h-4 bg-clinical-green rounded-full"></span>
                                Arrived at Hospital
                            </h3>
                        </div>
                        <div class="p-6 text-center">
                            <div
                                class="w-16 h-16 mx-auto bg-clinical-green/20 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-solid fa-flag-checkered text-3xl text-clinical-green"></i>
                            </div>
                            <p class="text-white">Transferring patient...</p>
                            <div class="mt-6">
                                <button onclick="updateStatus('PATIENT_ADMITTED')" class="btn-clinical">
                                    <i class="fa-solid fa-user-check"></i> Patient Admitted
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- STATE: PATIENT_ADMITTED -->
                    <div id="view-PATIENT_ADMITTED"
                        class="lifecycle-view hidden clinical-panel rounded-xl overflow-hidden">
                        <div class="bg-slate-900/70 px-5 py-3 border-b border-white/5">
                            <h3 class="font-medium text-white flex items-center gap-2 text-sm">
                                <span class="w-1 h-4 bg-clinical-blue rounded-full"></span>
                                Mission Complete
                            </h3>
                        </div>
                        <div class="p-6 text-center">
                            <div
                                class="w-16 h-16 mx-auto bg-clinical-blue/20 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-solid fa-circle-check text-3xl text-clinical-blue"></i>
                            </div>
                            <p class="text-white">Patient successfully admitted.</p>
                            <div class="mt-6">
                                <button onclick="updateStatus('COMPLETED')" class="btn-clinical">
                                    <i class="fa-solid fa-rotate-left"></i> Complete & Return to Idle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ========== 100% ORIGINAL JAVASCRIPT LOGIC (PRESERVED) ========== -->
    <script>
        // --------------------------------------------------------------------
        // ðŸš‘ ORIGINAL AMBULANCE LIFECYCLE LOGIC â€“ DO NOT MODIFY
        // --------------------------------------------------------------------
        let currentAmbulance = null;
        const API_BASE = 'http://localhost:3000';

        // Elements
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginMessage = document.getElementById('loginMessage');
        const registerPrompt = document.getElementById('registerPrompt');

        // Map Globals
        let map = null;
        let routeLayer = null;
        let markers = [];
        let ambulanceMarker = null;

        // Custom Ambulance Icon
        const ambulanceIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/263/263058.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        // Initialize Map â€“ ORIGINAL OSM LIGHT TILES
        function initMap() {
            if (map) return;
            map = L.map('map').setView([17.385, 78.486], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Animate ambulance along route (Vanishing Path)
        let animationInterval = null;

        function startAnimation(routeGeometry) {
            if (animationInterval) clearInterval(animationInterval);
            const coords = routeGeometry.coordinates;
            let step = 0;
            const totalSteps = coords.length;

            animationInterval = setInterval(() => {
                if (step >= totalSteps) {
                    clearInterval(animationInterval);
                    return;
                }
                const [lng, lat] = coords[step];
                const nextPos = [lat, lng];
                if (ambulanceMarker) {
                    ambulanceMarker.setLatLng(nextPos);
                    map.panTo(nextPos);
                }
                const remainingCoords = coords.slice(step);
                const leafletCoords = remainingCoords.map(c => [c[1], c[0]]);
                if (routeLayer) {
                    routeLayer.setLatLngs(leafletCoords);
                }
                step++;
            }, 1000);
        }

        function showSection(sectionId) {
            [loginSection, registerSection, dashboardSection].forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // --- AUTH ---
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) return;
            loginMessage.textContent = 'Logging in...';
            try {
                const res = await fetch(`${API_BASE}/ambulances/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (res.ok) {
                    const data = await res.json();
                    setLoggedIn(data);
                } else if (res.status === 401) {
                    loginMessage.textContent = 'Invalid credentials.';
                    registerPrompt.classList.remove('hidden');
                } else {
                    throw new Error('Login failed');
                }
            } catch (err) {
                console.error(err);
                loginMessage.textContent = 'Error connecting.';
            }
        }

        function showRegister() { showSection('registerSection'); }

        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());
            ['latitude', 'longitude'].forEach(k => payload[k] = Number(payload[k]));
            try {
                const res = await fetch(`${API_BASE}/ambulances/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    const data = await res.json();
                    setLoggedIn({ ...payload, ambulance_id: data.ambulance_id, status: 'IDLE' });
                } else {
                    const err = await res.json();
                    document.getElementById('registerMessage').textContent = err.error || 'Failed';
                }
            } catch (err) { console.error(err); }
        }

        function handleLogout() {
            currentAmbulance = null;
            showSection('loginSection');
        }

        function setLoggedIn(data) {
            currentAmbulance = data;
            document.getElementById('displayAmbulanceId').textContent = data.ambulance_id.substring(0, 8) + '...';
            document.getElementById('displayRegNum').textContent = data.registration_number || data.username || 'Unknown Ambulance';
            if (data.latitude) {
                document.getElementById('currentLat').value = data.latitude;
                document.getElementById('currentLng').value = data.longitude;
            } else {
                fetchDetails(data.ambulance_id);
            }
            renderLifecycleUI();
            showSection('dashboardSection');
        }

        async function fetchDetails(id) {
            try {
                const res = await fetch(`${API_BASE}/ambulances/${id}`);
                if (res.ok) {
                    const fullData = await res.json();
                    currentAmbulance = { ...currentAmbulance, ...fullData };
                    if (fullData.latitude) {
                        document.getElementById('currentLat').value = fullData.latitude;
                        document.getElementById('currentLng').value = fullData.longitude;
                    }
                    renderLifecycleUI();
                }
            } catch (e) { console.log('Fetch details failed', e); }
        }

        // --- LIFECYCLE MANAGEMENT ---
        function renderLifecycleUI() {
            const status = currentAmbulance.status || 'IDLE';
            document.getElementById('displayStatus').textContent = status;

            document.querySelectorAll('.lifecycle-view').forEach(el => el.classList.add('hidden'));
            const activeView = document.getElementById(`view-${status}`);
            if (activeView) {
                activeView.classList.remove('hidden');
            } else {
                const idleView = document.getElementById('view-IDLE');
                if (idleView) idleView.classList.remove('hidden');
                if (!document.getElementById('temp-reset-btn')) {
                    const btn = document.createElement('button');
                    btn.id = 'temp-reset-btn';
                    btn.textContent = `Reset Status from ${status} to IDLE`;
                    btn.onclick = () => updateStatus('IDLE');
                    btn.className = 'w-full bg-clinical-red hover:bg-clinical-red/90 text-white font-medium py-2 px-4 rounded-lg mt-4';
                    idleView.prepend(btn);
                }
            }

            if (status === 'HOSPITAL_SELECTED' || status === 'EN_ROUTE') {
                // Fetch and display active reservation details
                fetchActiveReservation();

                // Label will be updated by drawRouteToHospital when it fetches details
                document.getElementById('lbl-target-hospital').textContent = 'Loading...';
                setTimeout(() => {
                    initMap();
                    map.invalidateSize();
                    drawRouteToHospital(currentAmbulance.assigned_hospital_id);
                }, 100);
            } else {
                // Hide reservation panel if not in active reservation state
                const panel = document.getElementById('reservation-info-panel');
                if (panel) panel.classList.add('hidden');
                if (reservationTimer) clearInterval(reservationTimer);
            }
        }

        async function drawRouteToHospital(hospitalId) {
            if (animationInterval) clearInterval(animationInterval);
            if (!hospitalId || !currentAmbulance.latitude || !currentAmbulance.longitude) return;
            let endLat, endLng, hospName;
            try {
                const res = await fetch(`${API_BASE}/hospitals/${hospitalId}`);
                const h = await res.json();
                endLat = h.latitude;
                endLng = h.longitude;
                hospName = h.name;
                // Update the UI label with the real name
                const lbl = document.getElementById('lbl-target-hospital');
                if (lbl) lbl.textContent = hospName;
            } catch (e) { console.error(e); return; }

            if (routeLayer) map.removeLayer(routeLayer);
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const startLat = currentAmbulance.latitude;
            const startLng = currentAmbulance.longitude;

            if (ambulanceMarker) map.removeLayer(ambulanceMarker);
            ambulanceMarker = L.marker([startLat, startLng], { icon: ambulanceIcon }).addTo(map).bindPopup("Ambulance");
            const endMarker = L.marker([endLat, endLng]).addTo(map).bindPopup(hospName || "Destination");
            markers.push(endMarker);

            const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const latLngs = route.geometry.coordinates.map(c => [c[1], c[0]]);
                    routeLayer = L.polyline(latLngs, { color: '#2563eb', weight: 5 }).addTo(map);
                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                    if (currentAmbulance.status === 'EN_ROUTE') {
                        startAnimation(route.geometry);
                    }
                }
            } catch (err) { console.error("Route fetch error", err); }
        }

        async function updateStatus(newStatus, extras = {}) {
            if (!currentAmbulance) return;
            try {
                const payload = { new_status: newStatus, ...extras };
                const res = await fetch(`${API_BASE}/ambulances/${currentAmbulance.ambulance_id}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    const data = await res.json();
                    currentAmbulance.status = data.status;
                    if (extras.assigned_hospital_id) currentAmbulance.assigned_hospital_id = extras.assigned_hospital_id;
                    renderLifecycleUI();
                } else {
                    const err = await res.json();
                    alert(`Status update failed: ${err.error}`);
                }
            } catch (e) {
                console.error("Status Update Error", e);
                alert("Network error updating status");
            }
        }

        async function cancelCase() {
            if (confirm("Are you sure you want to cancel the current case?")) {
                await updateStatus('CANCELLED');
            }
        }

        // --- DECISION ENGINE ---
        async function handleDecisionRequest(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const formEntries = Object.fromEntries(formData.entries());

            // 1. Create Persistent Case
            let caseId = null;
            try {
                document.getElementById('decisionMessage').textContent = 'Creating Case Record...';

                const casePayload = {
                    ambulance_id: currentAmbulance.ambulance_id,
                    patient_age: Number(formEntries.patient_age),
                    patient_gender: formEntries.patient_gender,
                    severity_level: Number(formEntries.severity_level),
                    requires_icu: !!formEntries.requires_icu,
                    requires_specialty: formEntries.requires_specialty,
                    symptoms_summary: "Reported via Dispatch UI"
                };

                const caseRes = await fetch(`${API_BASE}/cases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(casePayload)
                });

                if (!caseRes.ok) throw new Error("Failed to create case record");
                const caseData = await caseRes.json();
                caseId = caseData.case_id;

                // 2. Update Ambulance Status with connected Case ID
                await updateStatus('CASE_CREATED', { active_case_id: caseId });

            } catch (err) {
                console.error("Case init failed", err);
                document.getElementById('decisionMessage').textContent = 'Error creating case: ' + err.message;
                return;
            }

            const payload = {
                request_id: crypto.randomUUID(),
                ambulance: {
                    ambulance_id: currentAmbulance.ambulance_id,
                    latitude: Number(formEntries.latitude),
                    longitude: Number(formEntries.longitude)
                },
                patient: {
                    age: Number(formEntries.patient_age),
                    severity_level: Number(formEntries.severity_level),
                    requires_icu: !!formEntries.requires_icu,
                    requires_specialty: formEntries.requires_specialty // Pass specialty to decision engine
                },
                constraints: {
                    max_distance_km: Number(formEntries.max_distance_km),
                    max_results: 5
                }
            };

            document.getElementById('decisionMessage').textContent = 'Analyzing...';

            try {
                const res = await fetch(`${API_BASE}/agent/decide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('decisionMessage').textContent = '';
                    renderResults(data.recommendations);
                } else {
                    document.getElementById('decisionMessage').textContent = 'Error fetching decisions';
                    await updateStatus('IDLE');
                }
            } catch (err) {
                console.error(err);
                await updateStatus('IDLE');
            }
        }

        function renderResults(hospitals) {
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            if (!hospitals.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-slate-500">No hospitals found. <button onclick="updateStatus(\'IDLE\')" class="text-clinical-blue underline">Back</button></td></tr>';
                return;
            }
            hospitals.forEach((h, index) => {
                const tr = document.createElement('tr');
                tr.className = index === 0 ? 'rank-1' : '';
                tr.innerHTML = `
                    <td class="text-center font-mono font-bold">#${index + 1}</td>
                    <td>
                        <strong class="text-white">${h.name || 'Hospital'}</strong>
                    </td>
                    <td>
                        <span class="font-mono text-clinical-blue">${h.distance_km.toFixed(2)} km</span><br>
                        <span class="text-xs text-slate-400">~${Math.round(h.eta_minutes)} mins</span>
                    </td>
                    <td class="font-mono font-bold text-clinical-blue">${h.score.toFixed(2)}</td>
                    <td>
                        <div class="text-xs">
                            <span class="text-slate-400">Beds:</span> ${h.snapshot.available_beds}<br>
                            <span class="text-slate-400">ICU:</span> ${h.snapshot.available_icu_beds}<br>
                            <span class="text-slate-400">Status:</span>
                            <span class="px-1.5 py-0.5 rounded-full text-[9px] font-medium
                                ${h.snapshot.status === 'NORMAL' ? 'bg-clinical-green/10 text-clinical-green' :
                        h.snapshot.status === 'CROWDED' ? 'bg-clinical-amber/10 text-clinical-amber' :
                            h.snapshot.status === 'OVERLOADED' ? 'bg-clinical-red/10 text-clinical-red' :
                                'bg-slate-700/50 text-slate-400'}">
                                ${h.snapshot.status}
                            </span>
                        </div>
                    </td>
                    <td>
                        <ul class="list-disc pl-4 text-xs text-slate-400" style="margin:0;">
                            ${h.reasons ? h.reasons.map(r => `<li>${r}</li>`).join('') : ''}
                        </ul>
                    </td>
                    <td class="text-right">
                        <button onclick="confirmSelection('${h.hospital_id}', '${h.name}')" 
                                class="bg-clinical-blue/10 hover:bg-clinical-blue text-clinical-blue hover:text-white border border-clinical-blue/30 font-medium py-1.5 px-4 rounded-lg transition-colors text-xs flex items-center justify-center gap-1.5 ml-auto">
                            <span>Select</span>
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function confirmSelection(hospitalId, hospitalName) {
            if (confirm(`Confirm selection of ${hospitalName}?`)) {
                await updateStatus('HOSPITAL_SELECTED', { assigned_hospital_id: hospitalId });
            }
        }

        // --- ðŸ†• RESERVATION LOGIC ---
        let reservationTimer = null;

        async function fetchActiveReservation() {
            if (!currentAmbulance) return;
            try {
                // Fetch from new endpoint: /reservations/active/:ambulance_id
                const res = await fetch(`${API_BASE}/reservations/active/${currentAmbulance.ambulance_id}`);
                if (res.ok) {
                    const data = await res.json();
                    renderReservationPanel(data);
                } else {
                    // Hide panel if 404 or error
                    document.getElementById('reservation-info-panel').classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching reservation:", error);
            }
        }

        function renderReservationPanel(data) {
            const panel = document.getElementById('reservation-info-panel');
            panel.classList.remove('hidden');

            document.getElementById('res-hospital-name').textContent = data.hospital_name || 'Unknown Hospital';
            document.getElementById('res-bed-type').textContent = data.bed_type;
            document.getElementById('res-id').textContent = data.reservation_id.substring(0, 8) + '...';

            // Set styles based on bed type
            const bedBadge = document.getElementById('res-bed-type');
            if (data.bed_type === 'ICU') {
                bedBadge.className = 'text-sm font-bold bg-clinical-red/20 text-clinical-red px-2 rounded border border-clinical-red/30';
            } else {
                bedBadge.className = 'text-sm font-mono bg-slate-800 px-2 rounded text-slate-300 border border-slate-700';
            }

            if (data.expires_at) {
                startReservationTimer(data.expires_at);
            } else {
                document.getElementById('res-timer').textContent = "---";
            }
        }

        function startReservationTimer(expiryTimestamp) {
            if (reservationTimer) clearInterval(reservationTimer);

            const expiryTime = new Date(expiryTimestamp).getTime();
            const timerEl = document.getElementById('res-timer');

            function update() {
                const now = new Date().getTime();
                const distance = expiryTime - now;

                if (distance < 0) {
                    clearInterval(reservationTimer);
                    timerEl.textContent = "EXPIRED";
                    timerEl.classList.add('text-clinical-red');

                    // Handle Expiry: Alert & Reset if not Arrived
                    // Only reset if we are not yet ARRIVED or PATIENT_ADMITTED
                    if (currentAmbulance.status === 'HOSPITAL_SELECTED' || currentAmbulance.status === 'EN_ROUTE') {
                        alert("âš ï¸ RESERVATION EXPIRED! Returning to IDLE.");
                        updateStatus('IDLE');
                    }
                    return;
                }

                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerEl.textContent = `${minutes}m ${seconds}s`;
                timerEl.classList.remove('text-clinical-red');
            }

            update(); // Initial call
            reservationTimer = setInterval(update, 1000);
        }
    </script>

    <!-- ========== ENHANCEMENT LAYER (Clock, Geolocation) â€“ ADDITIVE ========== -->
    <script>
        // ---------- â° DIGITAL CLOCK ----------
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ---------- ðŸ“¡ GEOLOCATION FOR REGISTER FORM ----------
        window.fillRegisterLocation = function () {
            const btn = document.querySelector('button[onclick="fillRegisterLocation()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ACQUIRING...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    document.getElementById('reg_lat').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('reg_lng').value = pos.coords.longitude.toFixed(6);
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> LOCKED';
                    btn.classList.add('text-clinical-green');
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fa-solid fa-satellite-dish"></i> Autoâ€‘Fix';
                        btn.classList.remove('text-clinical-green');
                    }, 2000);
                }, (err) => {
                    alert('GEOLOCATION ERROR: ' + err.message);
                    btn.innerHTML = '<i class="fa-solid fa-satellite-dish"></i> Autoâ€‘Fix';
                });
            } else {
                alert('GEOLOCATION NOT SUPPORTED');
                btn.innerHTML = '<i class="fa-solid fa-satellite-dish"></i> Autoâ€‘Fix';
            }
        };

        // ---------- ðŸ“¡ GEOLOCATION FOR DASHBOARD ----------
        window.getCurrentLocation = function () {
            if (!navigator.geolocation) { alert("Geolocation not supported."); return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                document.getElementById('currentLat').value = pos.coords.latitude.toFixed(6);
                document.getElementById('currentLng').value = pos.coords.longitude.toFixed(6);
                if (currentAmbulance) {
                    currentAmbulance.latitude = pos.coords.latitude;
                    currentAmbulance.longitude = pos.coords.longitude;
                }
            }, (err) => {
                alert('Geolocation error: ' + err.message);
            });
        };
    </script>

</body>

</html>