<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambulance Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section {
            margin-bottom: 2rem;
            border: 1px solid #ddd;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        input,
        select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        button {
            background-color: #dc3545;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #c82333;
        }

        .error {
            color: red;
            margin-top: 0.5rem;
        }

        .success {
            color: green;
            margin-top: 0.5rem;
        }

        h2 {
            margin-top: 0;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #f8f9fa;
        }

        .rank-1 {
            background-color: #d4edda;
            border: 2px solid #28a745;
        }

        .score {
            font-weight: bold;
            color: #0056b3;
        }

        #map {
            height: 400px;
            width: 100%;
            margin-top: 2rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>Ambulance Dispatch Interface</h1>

    <!-- Login Section -->
    <div id="loginSection" class="section">
        <h2>Ambulance Login</h2>
        <label for="loginRegNum">Registration Number</label>
        <input type="text" id="loginRegNum" placeholder="e.g., TS-08-1234">
        <button onclick="handleLogin()">Login</button>
        <div id="loginMessage"></div>
        <div id="registerPrompt" class="hidden" style="margin-top: 1rem;">
            <p>Ambulance not found.</p>
            <button onclick="showRegister()">Register New Ambulance</button>
        </div>
    </div>

    <!-- Register Section -->
    <div id="registerSection" class="section hidden">
        <h2>Register Ambulance</h2>
        <form id="registerForm" onsubmit="handleRegister(event)">
            <label>Registration Number</label>
            <input type="text" name="registration_number" required>

            <label>Organization</label>
            <input type="text" name="organization" placeholder="e.g., GVK EMRI" required>

            <label>Latitude</label>
            <input type="number" step="any" name="latitude" required>

            <label>Longitude</label>
            <input type="number" step="any" name="longitude" required>

            <button type="submit">Register & Login</button>
        </form>
        <div id="registerMessage"></div>
    </div>

    <!-- Dashboard/Patient Form Section -->
    <div id="dashboardSection" class="section hidden">
        <h2>Find Hospitals</h2>
        <p>Ambulance ID: <span id="displayAmbulanceId" style="font-weight: bold;"></span></p>
        <p>Registration: <span id="displayRegNum"></span></p>

        <form id="decisionForm" onsubmit="handleDecisionRequest(event)">
            <div style="display: flex; gap: 2rem;">
                <div style="flex: 1;">
                    <h3>Patient Details</h3>
                    <label>Age</label>
                    <input type="number" name="patient_age" required>

                    <label>Gender</label>
                    <select name="patient_gender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>

                    <label>Severity Level (1-5)</label>
                    <input type="number" name="severity_level" min="1" max="5" required>

                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" name="requires_icu" id="reqICU">
                        <label for="reqICU" style="display:inline;">Requires ICU</label>
                    </div>

                    <label>Requires Specialty (Optional)</label>
                    <input type="text" name="requires_specialty" placeholder="e.g., Cardiology">
                </div>

                <div style="flex: 1;">
                    <h3>Ambulance Location & Constraints</h3>
                    <label>Current Latitude</label>
                    <input type="number" step="any" name="latitude" id="currentLat" required>

                    <label>Current Longitude</label>
                    <input type="number" step="any" name="longitude" id="currentLng" required>

                    <label>Max Distance (km)</label>
                    <input type="number" name="max_distance_km" value="15" required>

                    <label>Max Results</label>
                    <input type="number" name="max_results" value="5" required>
                </div>
            </div>

            <button type="submit" style="width: 100%; font-size: 1.1rem;">Find Best Hospitals</button>
        </form>
        <div id="decisionMessage"></div>

        <!-- Results -->
        <div id="resultsArea" class="hidden">
            <h3>Recommended Hospitals</h3>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Hospital</th>
                        <th>Distance / ETA</th>
                        <th>Score</th>
                        <th>Status Snapshot</th>
                        <th>Reasoning</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="map"></div>
        </div>
    </div>

    <script>
        // State
        let currentAmbulance = null;
        const API_BASE = 'http://localhost:3000'; // Adjust if needed

        // Elements
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginMessage = document.getElementById('loginMessage');
        const registerPrompt = document.getElementById('registerPrompt');
        const resultsArea = document.getElementById('resultsArea');
        const resultsTableBody = document.querySelector('#resultsTable tbody');

        function showSection(sectionId) {
            [loginSection, registerSection, dashboardSection].forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        async function handleLogin() {
            const regNum = document.getElementById('loginRegNum').value;
            if (!regNum) return;

            loginMessage.textContent = 'Logging in...';
            loginMessage.className = '';
            registerPrompt.classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/ambulances/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ registration_number: regNum })
                });

                if (res.ok) {
                    const data = await res.json();
                    setLoggedIn(data);
                } else {
                    if (res.status === 401) {
                        loginMessage.textContent = 'Ambulance not registered.';
                        loginMessage.className = 'error';
                        registerPrompt.classList.remove('hidden');
                    } else {
                        throw new Error('Login failed');
                    }
                }
            } catch (err) {
                console.error(err);
                loginMessage.textContent = 'Error connecting to server.';
                loginMessage.className = 'error';
            }
        }

        function showRegister() {
            showSection('registerSection');
            // Pre-fill registration number if user typed it
            document.querySelector('#registerForm [name="registration_number"]').value =
                document.getElementById('loginRegNum').value;
        }

        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());

            ['latitude', 'longitude'].forEach(k => payload[k] = Number(payload[k]));

            const msgDiv = document.getElementById('registerMessage');
            msgDiv.textContent = 'Registering...';
            msgDiv.className = '';

            try {
                const res = await fetch(`${API_BASE}/ambulances/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const data = await res.json();
                    const loginData = {
                        ...payload,
                        ambulance_id: data.ambulance_id
                    };
                    setLoggedIn(loginData);
                } else {
                    const errFn = await res.json();
                    msgDiv.textContent = 'Registration failed: ' + (errFn.error || 'Unknown error');
                    msgDiv.className = 'error';
                }
            } catch (err) {
                console.error(err);
                msgDiv.textContent = 'Error registering.';
                msgDiv.className = 'error';
            }
        }

        function setLoggedIn(data) {
            currentAmbulance = data;
            document.getElementById('displayAmbulanceId').textContent = data.ambulance_id;
            document.getElementById('displayRegNum').textContent = data.registration_number;

            // Pre-fill location if available
            if (data.latitude) document.getElementById('currentLat').value = data.latitude;
            if (data.longitude) document.getElementById('currentLng').value = data.longitude;

            showSection('dashboardSection');

            // If we don't have lat/long (e.g. from login), fetch them
            if (!data.latitude) {
                fetchDetails(data.ambulance_id);
            }
        }

        async function fetchDetails(id) {
            try {
                const res = await fetch(`${API_BASE}/ambulances/${id}`);
                if (res.ok) {
                    const fullData = await res.json();
                    currentAmbulance = { ...currentAmbulance, ...fullData };
                    if (fullData.latitude) document.getElementById('currentLat').value = fullData.latitude;
                    if (fullData.longitude) document.getElementById('currentLng').value = fullData.longitude;
                }
            } catch (e) { console.log('Could not fetch full details', e); }
        }

        async function handleDecisionRequest(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const formEntries = Object.fromEntries(formData.entries());

            // Construct hierarchical payload
            const payload = {
                request_id: crypto.randomUUID(),
                ambulance: {
                    ambulance_id: currentAmbulance.ambulance_id,
                    latitude: Number(formEntries.latitude),
                    longitude: Number(formEntries.longitude)
                },
                patient: {
                    patient_age: Number(formEntries.patient_age),
                    patient_gender: formEntries.patient_gender,
                    severity_level: Number(formEntries.severity_level),
                    requires_icu: !!formEntries.requires_icu, // checkbox presence check
                    requires_specialty: formEntries.requires_specialty || null
                },
                constraints: {
                    max_distance_km: Number(formEntries.max_distance_km),
                    max_results: Number(formEntries.max_results)
                }
            };

            const msgDiv = document.getElementById('decisionMessage');
            msgDiv.textContent = 'Finding hospitals...';
            msgDiv.className = '';
            resultsArea.classList.add('hidden');
            resultsTableBody.innerHTML = '';

            try {
                const res = await fetch(`${API_BASE}/agent/decide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const data = await res.json();
                    msgDiv.textContent = `Found ${data.recommendations.length} hospitals. Best option: ${data.recommendations[0]?.name || 'None'}`;
                    msgDiv.className = 'success';
                    renderResults(data.recommendations);
                } else {
                    const errFn = await res.json();
                    msgDiv.textContent = 'Decision failed: ' + (errFn.error || 'Unknown error');
                    msgDiv.className = 'error';
                }
            } catch (err) {
                console.error(err);
                msgDiv.textContent = 'Error connecting to server.';
                msgDiv.className = 'error';
            }
        }

        // Map State
        let map = null;
        let routeLayer = null;
        let markers = [];

        function initMap() {
            if (map) return;
            // Default to Hyderabad
            map = L.map('map').setView([17.3850, 78.4867], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }

        async function selectHospital(hospital) {
            if (!currentAmbulance || !currentAmbulance.latitude || !currentAmbulance.longitude) {
                alert("Ambulance location unknown");
                return;
            }

            // Ensure map is initialized
            initMap();

            // Clear previous route and markers
            if (routeLayer) map.removeLayer(routeLayer);
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const startLat = currentAmbulance.latitude;
            const startLng = currentAmbulance.longitude;

            // Get hospital location (from hospital object or snapshot)
            // The constraint says: "use hospital object lat/long"
            // We need to ensure these are present. If not in root, check snapshot or mock it? 
            // The prompt says: "hospital latitude & longitude should be taken from agent response if present otherwise add them as hidden fields"
            // For now assuming they are on the hospital object as per standard structure.
            let endLat = hospital.latitude;
            let endLng = hospital.longitude;

            // If coordinates are missing, fetch them
            if (!endLat || !endLng) {
                try {
                    // console.log(`Fetching details for hospital ${hospital.hospital_id}...`);
                    const res = await fetch(`${API_BASE}/hospitals/${hospital.hospital_id}`);
                    if (res.ok) {
                        const fullData = await res.json();
                        endLat = fullData.latitude;
                        endLng = fullData.longitude;
                        // Update the hospital object for future clicks
                        hospital.latitude = endLat;
                        hospital.longitude = endLng;
                    } else {
                        console.error('Failed to fetch hospital details', await res.text());
                    }
                } catch (err) {
                    console.error('Error fetching hospital details:', err);
                }
            }

            if (!endLat || !endLng) {
                alert("Selected hospital coordinates missing and could not be fetched.");
                return;
            }

            // Markers
            const startMarker = L.marker([startLat, startLng]).addTo(map).bindPopup("Ambulance");
            const endMarker = L.marker([endLat, endLng]).addTo(map).bindPopup(hospital.name);
            markers.push(startMarker, endMarker);

            // Fetch Route from OSRM
            const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const geojson = route.geometry;

                    // Draw Polyline
                    routeLayer = L.geoJSON(geojson, {
                        style: { color: 'blue', weight: 5 }
                    }).addTo(map);

                    // Fit bounds
                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                } else {
                    alert("No route found.");
                }
            } catch (err) {
                console.error("OSRM Error:", err);
                alert("Failed to fetch route.");
            }
        }

        function renderResults(hospitals) {
            resultsArea.classList.remove('hidden');

            if (!hospitals || hospitals.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="7">No hospitals found matching constraints.</td></tr>';
                return;
            }

            // Initialize map if not already done, just to be ready (or wait for click)
            // But better to init only when needed or after results are shown?
            // User requirement: "Add a <div id='map'></div> below the results table" - done.
            // Requirement 2: "Initialize Leaflet map using..."
            // We can init it once results are shown or on first click. Let's do it on first click to save resources if not used, 
            // OR simply call initMap() here if we want to show the start point immediately? 
            // PROMPT: "Select one hospital... Visualize route".
            // Let's lazy load on click to keep it clean, or init empty map. 
            // Let's init empty map so user sees it exists.
            setTimeout(initMap, 100);

            hospitals.forEach((h, index) => {
                const tr = document.createElement('tr');
                if (index === 0) tr.className = 'rank-1'; // Highlight best

                // Reasoning bullets (Fix: 'reasoning' -> 'reasons')
                const reasonsList = h.reasons ? h.reasons.map(r => `<li>${r}</li>`).join('') : '';

                // Serialize hospital object for the button click
                // We need to ensure we don't break HTML with quotes.
                // A safer way is to store hospitals in a global array and reference by index.

                const btnId = `route-btn-${index}`;

                tr.innerHTML = `
                    <td style="text-align:center; font-weight:bold;">#${index + 1}</td>
                    <td>
                        <strong>${h.name || 'Hospital ' + h.hospital_id.substring(0, 8)}</strong><br>
                        <small>ID: ${h.hospital_id}</small>
                    </td>
                    <td>
                        ${h.distance_km.toFixed(2)} km<br>
                        ~${Math.round(h.eta_minutes)} mins
                    </td>
                    <td class="score">${h.score.toFixed(2)}</td>
                    <td>
                        <small>
                            Beds: ${h.snapshot.available_beds}<br>
                            ICU: ${h.snapshot.available_icu_beds}<br>
                            Status: <b>${h.snapshot.status}</b>
                        </small>
                    </td>
                    <td>
                        <ul style="margin:0; padding-left:1.2rem;">${reasonsList}</ul>
                    </td>
                    <td>
                        <button id="${btnId}" style="background-color: #007bff; padding: 0.5rem 1rem;">Select & Route</button>
                    </td>
                `;
                resultsTableBody.appendChild(tr);

                // Add event listener safely
                document.getElementById(btnId).addEventListener('click', () => selectHospital(h));
            });
        }
    </script>
</body>

</html>