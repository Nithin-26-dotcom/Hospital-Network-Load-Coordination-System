<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambulance Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section {
            margin-bottom: 2rem;
            border: 1px solid #ddd;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        input,
        select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        button {
            background-color: #dc3545;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #c82333;
        }

        .error {
            color: red;
            margin-top: 0.5rem;
        }

        .success {
            color: green;
            margin-top: 0.5rem;
        }

        h2 {
            margin-top: 0;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #f8f9fa;
        }

        .rank-1 {
            background-color: #d4edda;
            border: 2px solid #28a745;
        }

        .score {
            font-weight: bold;
            color: #0056b3;
        }

        #map {
            height: 400px;
            width: 100%;
            margin-top: 2rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            /* Remove display:none issues */
        }
    </style>
</head>

<body>
    <h1>Ambulance Dispatch Interface</h1>

    <!-- Login Section -->
    <div id="loginSection" class="section">
        <h2>Ambulance Login</h2>
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" placeholder="Enter Username">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter Password">
        <button onclick="handleLogin()">Login</button>
        <div id="loginMessage"></div>
        <div id="registerPrompt" class="hidden" style="margin-top: 1rem;">
            <p>Ambulance not found.</p>
            <button onclick="showRegister()">Register New Ambulance</button>
        </div>
    </div>

    <!-- Register Section -->
    <div id="registerSection" class="section hidden">
        <h2>Register Ambulance</h2>
        <form id="registerForm" onsubmit="handleRegister(event)">
            <label>Username</label>
            <input type="text" name="username" required>

            <label>Password</label>
            <input type="password" name="password" required>

            <label>Registration Number</label>
            <input type="text" name="registration_number" required>

            <label>Organization</label>
            <input type="text" name="organization" placeholder="e.g., GVK EMRI" required>

            <label>Latitude</label>
            <input type="number" step="any" name="latitude" required>

            <label>Longitude</label>
            <input type="number" step="any" name="longitude" required>

            <button type="submit">Register & Login</button>
        </form>
        <div id="registerMessage"></div>
    </div>

    <!-- Dashboard/Patient Form Section -->
    <div id="dashboardSection" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Ambulance Dashboard</h2>
            <div style="text-align: right;">
                <span id="displayStatus"
                    style="padding: 0.5rem; background: #eee; border-radius: 4px; font-weight: bold;">IDLE</span>
                <button onclick="handleLogout()"
                    style="background-color: #6c757d; margin-left: 1rem; padding: 0.5rem;">Logout</button>
            </div>
        </div>

        <p>Ambulance ID: <span id="displayAmbulanceId" style="font-weight: bold;"></span></p>

        <!-- Dynamic Content Based on Status -->
        <div id="lifecycleContainer">

            <!-- STATE: IDLE -->
            <div id="view-IDLE" class="lifecycle-view hidden">
                <h3>Start New Case</h3>
                <form id="decisionForm" onsubmit="handleDecisionRequest(event)">
                    <div style="display: flex; gap: 2rem;">
                        <div style="flex: 1;">
                            <h4>Patient Details</h4>
                            <label>Age</label>
                            <input type="number" name="patient_age" required>

                            <label>Gender</label>
                            <select name="patient_gender">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>

                            <label>Severity Level (1-5)</label>
                            <input type="number" name="severity_level" min="1" max="5" required>

                            <div style="margin-bottom: 1rem;">
                                <input type="checkbox" name="requires_icu" id="reqICU">
                                <label for="reqICU" style="display:inline;">Requires ICU</label>
                            </div>

                            <label>Requires Specialty (Optional)</label>
                            <input type="text" name="requires_specialty" placeholder="e.g., Cardiology">
                        </div>

                        <div style="flex: 1;">
                            <h4>Location & Constraints</h4>
                            <label>Current Latitude</label>
                            <input type="number" step="any" name="latitude" id="currentLat" required>

                            <label>Current Longitude</label>
                            <input type="number" step="any" name="longitude" id="currentLng" required>

                            <label>Max Distance (km)</label>
                            <input type="number" name="max_distance_km" value="15" required>

                            <label>Max Results</label>
                            <input type="number" name="max_results" value="5" required>
                        </div>
                    </div>

                    <button type="submit" style="width: 100%; font-size: 1.1rem; background-color: #007bff;">Find Best
                        Hospitals</button>
                </form>
                <div id="decisionMessage"></div>
            </div>

            <!-- STATE: CASE_CREATED (Results) -->
            <div id="view-CASE_CREATED" class="lifecycle-view hidden">
                <h3>Select Destination Hospital</h3>
                <div id="resultsArea">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Hospital</th>
                                <th>Distance / ETA</th>
                                <th>Score</th>
                                <th>Status Snapshot</th>
                                <th>Reasoning</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button onclick="cancelCase()" style="margin-top: 1rem; background-color: #6c757d;">Cancel Case</button>
            </div>

            <!-- STATE: HOSPITAL_SELECTED -->
            <div id="view-HOSPITAL_SELECTED" class="lifecycle-view hidden">
                <h3 style="color: #007bff;">Hospital Selected!</h3>
                <p>Target: <b id="lbl-target-hospital">...</b></p>
                <p>Prepare for transport.</p>
                <button onclick="updateStatus('EN_ROUTE')"
                    style="width: 100%; font-size: 1.2rem; background-color: #28a745;">Start Route üöë</button>
                <button onclick="cancelCase()" style="margin-top: 1rem; background-color: #dc3545;">Cancel</button>
            </div>

            <!-- STATE: EN_ROUTE -->
            <div id="view-EN_ROUTE" class="lifecycle-view hidden">
                <h3 style="color: #fd7e14;">En Route to Hospital</h3>
                <!-- Map will be appended here dynamically -->
                <button onclick="updateStatus('ARRIVED')"
                    style="width: 100%; font-size: 1.2rem; background-color: #17a2b8;">Mark Arrived üìç</button>
            </div>

            <!-- STATE: ARRIVED -->
            <div id="view-ARRIVED" class="lifecycle-view hidden">
                <h3 style="color: #28a745;">Arrived at Hospital</h3>
                <p>Transferring patient...</p>
                <button onclick="updateStatus('PATIENT_ADMITTED')"
                    style="width: 100%; font-size: 1.2rem; background-color: #28a745;">Patient Admitted ‚úÖ</button>
            </div>

            <!-- STATE: PATIENT_ADMITTED -->
            <div id="view-PATIENT_ADMITTED" class="lifecycle-view hidden">
                <h3 style="color: #6f42c1;">Mission Complete</h3>
                <p>Patient successfully admitted.</p>
                <button onclick="updateStatus('COMPLETED')"
                    style="width: 100%; font-size: 1.2rem; background-color: #007bff;">Complete & Return to Idle
                    üèÅ</button>
            </div>

        </div>

        <!-- Shared Map Container (moved out of specific views if needed, or mapped dynamically) -->
        <!-- For now, we only use map in EN_ROUTE or results. Let's keep a generic map container below -->
        <div id="map" class="hidden"></div>
    </div>

    <script>
        // State
        let currentAmbulance = null;
        const API_BASE = 'http://localhost:3000';

        // Elements
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginMessage = document.getElementById('loginMessage');
        const registerPrompt = document.getElementById('registerPrompt');

        // Map Globals
        let map = null;
        let routeLayer = null;
        let markers = [];
        let ambulanceMarker = null;

        // Custom Ambulance Icon
        // Use a standard public icon valid for data URI usage to avoid btoa issues with emojis
        const ambulanceIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/263/263058.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        // Initialize Map
        function initMap() {
            if (map) return;
            map = L.map('map').setView([17.385, 78.486], 13); // Default to Hyderabad
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Animate ambulance along route (Vanishing Path)
        let animationInterval = null;

        function startAnimation(routeGeometry) {
            if (animationInterval) clearInterval(animationInterval);

            // OSRM returns [lng, lat], Leaflet needs [lat, lng]
            // We need to store original for slicing, but converted for display
            const coords = routeGeometry.coordinates;
            let step = 0;
            const totalSteps = coords.length;

            animationInterval = setInterval(() => {
                if (step >= totalSteps) {
                    clearInterval(animationInterval);
                    return;
                }

                const [lng, lat] = coords[step];
                const nextPos = [lat, lng];

                // 1. Move Ambulance Marker
                if (ambulanceMarker) {
                    ambulanceMarker.setLatLng(nextPos);
                    map.panTo(nextPos);
                }

                // 2. Vanish Path (Update Polyline)
                // Slice from current step to end
                const remainingCoords = coords.slice(step);
                // Convert to LatLngs for Leaflet
                const leafletCoords = remainingCoords.map(c => [c[1], c[0]]);

                if (routeLayer) {
                    routeLayer.setLatLngs(leafletCoords);
                }

                step++;
            }, 1000); // Move every second
        }

        function showSection(sectionId) {
            [loginSection, registerSection, dashboardSection].forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // --- AUTH ---

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) return;

            loginMessage.textContent = 'Logging in...';
            try {
                const res = await fetch(`${API_BASE}/ambulances/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (res.ok) {
                    const data = await res.json();
                    setLoggedIn(data);
                } else if (res.status === 401) {
                    loginMessage.textContent = 'Invalid credentials.';
                    registerPrompt.classList.remove('hidden');
                } else {
                    throw new Error('Login failed');
                }
            } catch (err) {
                console.error(err);
                loginMessage.textContent = 'Error connecting.';
            }
        }

        function showRegister() { showSection('registerSection'); }

        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());
            ['latitude', 'longitude'].forEach(k => payload[k] = Number(payload[k]));

            try {
                const res = await fetch(`${API_BASE}/ambulances/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    const data = await res.json();
                    setLoggedIn({ ...payload, ambulance_id: data.ambulance_id, status: 'IDLE' });
                } else {
                    const err = await res.json();
                    document.getElementById('registerMessage').textContent = err.error || 'Failed';
                }
            } catch (err) { console.error(err); }
        }

        function handleLogout() {
            currentAmbulance = null;
            showSection('loginSection');
        }

        function setLoggedIn(data) {
            currentAmbulance = data;
            document.getElementById('displayAmbulanceId').textContent = data.ambulance_id;

            // Initial Location Check
            if (data.latitude) {
                document.getElementById('currentLat').value = data.latitude;
                document.getElementById('currentLng').value = data.longitude;
            } else {
                fetchDetails(data.ambulance_id);
            }

            // Render correct UI based on status
            renderLifecycleUI();
            showSection('dashboardSection');
        }

        async function fetchDetails(id) {
            try {
                const res = await fetch(`${API_BASE}/ambulances/${id}`);
                if (res.ok) {
                    const fullData = await res.json();
                    currentAmbulance = { ...currentAmbulance, ...fullData };
                    if (fullData.latitude) {
                        document.getElementById('currentLat').value = fullData.latitude;
                        document.getElementById('currentLng').value = fullData.longitude;
                    }
                    renderLifecycleUI(); // Re-render in case status changed
                }
            } catch (e) { console.log('Fetch details failed', e); }
        }

        // --- LIFECYCLE MANAGEMENT ---

        function renderLifecycleUI() {
            const status = currentAmbulance.status || 'IDLE';
            document.getElementById('displayStatus').textContent = status;

            // Hide all views
            document.querySelectorAll('.lifecycle-view').forEach(el => el.classList.add('hidden'));

            // Show current view
            const activeView = document.getElementById(`view-${status}`);
            if (activeView) {
                activeView.classList.remove('hidden');
            } else {
                // Handle unknown status
                const idleView = document.getElementById('view-IDLE');
                if (idleView) idleView.classList.remove('hidden');
                if (!document.getElementById('temp-reset-btn')) {
                    const btn = document.createElement('button');
                    btn.id = 'temp-reset-btn';
                    btn.textContent = `Reset Status from ${status} to IDLE`;
                    btn.onclick = () => updateStatus('IDLE');
                    btn.style.backgroundColor = '#dc3545';
                    btn.style.width = '100%';
                    btn.style.marginTop = '1rem';
                    idleView.prepend(btn);
                }
            }

            // Map Logic
            const mapContainer = document.getElementById('map');

            if (status === 'HOSPITAL_SELECTED' || status === 'EN_ROUTE') {
                document.getElementById('lbl-target-hospital').textContent = currentAmbulance.assigned_hospital_id || 'Unknown';

                // Show Map
                mapContainer.classList.remove('hidden');

                // Move map to the active view logic
                if (activeView && !activeView.contains(mapContainer)) {
                    activeView.appendChild(mapContainer);
                }

                // Initialize and Draw Route
                // Use setTimeout to allow DOM to update (display:block) before Leaflet resize
                setTimeout(() => {
                    initMap();
                    map.invalidateSize();
                    drawRouteToHospital(currentAmbulance.assigned_hospital_id);
                }, 100);

            } else {
                // Hide map for other states (or move it back to body if needed to preserve instance)
                mapContainer.classList.add('hidden');
            }
        }

        async function drawRouteToHospital(hospitalId) {
            if (!hospitalId || !currentAmbulance.latitude || !currentAmbulance.longitude) return;

            // Fetch hospital details
            let endLat, endLng, hospName;
            try {
                const res = await fetch(`${API_BASE}/hospitals/${hospitalId}`);
                const h = await res.json();
                endLat = h.latitude;
                endLng = h.longitude;
                hospName = h.name;
            } catch (e) { console.error(e); return; }

            // Clear existing layers
            if (routeLayer) map.removeLayer(routeLayer);
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const startLat = currentAmbulance.latitude;
            const startLng = currentAmbulance.longitude;

            // Markers
            ambulanceMarker = L.marker([startLat, startLng], { icon: ambulanceIcon }).addTo(map).bindPopup("Ambulance");
            const endMarker = L.marker([endLat, endLng]).addTo(map).bindPopup(hospName || "Destination");
            markers.push(endMarker);

            // OSRM Route
            const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];

                    // Initial Polyline
                    // OSRM returns [lng, lat], Leaflet needs [lat, lng]
                    const latLngs = route.geometry.coordinates.map(c => [c[1], c[0]]);

                    routeLayer = L.polyline(latLngs, { color: 'blue', weight: 5 }).addTo(map);
                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

                    if (currentAmbulance.status === 'EN_ROUTE') {
                        startAnimation(route.geometry);
                    }
                }
            } catch (err) { console.error("Route fetch error", err); }
        }

        async function updateStatus(newStatus, extras = {}) {
            if (!currentAmbulance) return;

            try {
                const payload = { new_status: newStatus, ...extras };
                const res = await fetch(`${API_BASE}/ambulances/${currentAmbulance.ambulance_id}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const data = await res.json();
                    currentAmbulance.status = data.status;
                    if (extras.assigned_hospital_id) currentAmbulance.assigned_hospital_id = extras.assigned_hospital_id;
                    renderLifecycleUI();
                } else {
                    const err = await res.json();
                    alert(`Status update failed: ${err.error}`);
                }
            } catch (e) {
                console.error("Status Update Error", e);
                alert("Network error updating status");
            }
        }

        async function cancelCase() {
            if (confirm("Are you sure you want to cancel the current case?")) {
                await updateStatus('CANCELLED');
            }
        }

        // --- DECISION ENGINE ---

        async function handleDecisionRequest(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const formEntries = Object.fromEntries(formData.entries());

            // 1. Update State to CASE_CREATED first (Optional, but good for tracking)
            // Actually, we can just fetch recommendations and if successful, transition state implicitly?
            // STRICT MODE: We should ideally transition to CASE_CREATED on server.
            // Let's do a quick local status update to show results, then actual transition happens on selection?
            // OR: API call first.

            await updateStatus('CASE_CREATED');

            const payload = {
                request_id: crypto.randomUUID(),
                ambulance: {
                    ambulance_id: currentAmbulance.ambulance_id,
                    latitude: Number(formEntries.latitude),
                    longitude: Number(formEntries.longitude)
                },
                patient: {
                    age: Number(formEntries.patient_age),
                    severity_level: Number(formEntries.severity_level),
                    requires_icu: !!formEntries.requires_icu
                },
                constraints: {
                    max_distance_km: Number(formEntries.max_distance_km),
                    max_results: 5
                }
            };

            document.getElementById('decisionMessage').textContent = 'Analyzing...';

            try {
                const res = await fetch(`${API_BASE}/agent/decide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('decisionMessage').textContent = '';
                    renderResults(data.recommendations);
                } else {
                    document.getElementById('decisionMessage').textContent = 'Error fetching decisions';
                    // Revert?
                    await updateStatus('IDLE');
                }
            } catch (err) {
                console.error(err);
                await updateStatus('IDLE');
            }
        }

        function renderResults(hospitals) {
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';

            if (!hospitals.length) {
                tbody.innerHTML = '<tr><td colspan="7">No hospitals found. <button onclick="updateStatus(\'IDLE\')">Back</button></td></tr>';
                return;
            }

            hospitals.forEach((h, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${index + 1}</td>
                    <td><b>${h.name || h.hospital_id}</b></td>
                    <td>${h.distance_km.toFixed(2)} km / ${Math.round(h.eta_minutes)} min</td>
                    <td>${h.score.toFixed(2)}</td>
                    <td>${h.snapshot.status}</td>
                    <td>${h.reasons ? h.reasons.join(', ') : ''}</td>
                    <td><button onclick="confirmSelection('${h.hospital_id}', '${h.name}')" style="background-color: #007bff; padding: 5px;">Select</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function confirmSelection(hospitalId, hospitalName) {
            if (confirm(`Confirm selection of ${hospitalName}?`)) {
                await updateStatus('HOSPITAL_SELECTED', { assigned_hospital_id: hospitalId });
            }
        }
    </script>
</body>

</html>