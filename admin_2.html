<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>City‚ÄëWide Ambulance Monitor ¬∑ Command Center</title>

    <!-- Tailwind (clinical‚Äëfocused config) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#0a0e1a',
                        },
                        clinical: {
                            blue: '#2563eb',
                            red: '#dc2626',
                            green: '#16a34a',
                            amber: '#d97706',
                            gray: '#6b7280',
                        }
                    },
                    backgroundImage: {
                        'grid-subtle': 'linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px)',
                    }
                }
            }
        }
    </script>

    <!-- Fonts + Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet Core -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ---------- CLINICAL GRADE ‚Äì CLEAN, PROFESSIONAL ---------- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0e1a;
            background-image: radial-gradient(circle at 20% 30%, rgba(37, 99, 235, 0.02) 0%, transparent 30%),
                radial-gradient(circle at 80% 70%, rgba(22, 163, 74, 0.02) 0%, transparent 40%);
            background-attachment: fixed;
        }

        /* ----- Custom Scrollbar (subtle) ----- */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        /* ----- Clinical Panel ‚Äì clean glass ----- */
        .clinical-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 20px -8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .clinical-panel:hover {
            border-color: rgba(37, 99, 235, 0.3);
            box-shadow: 0 12px 24px -10px rgba(37, 99, 235, 0.2);
        }

        /* ----- Input ‚Äì clean, no glow ----- */
        .input-clinical {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(37, 99, 235, 0.5);
            transition: all 0.2s ease;
            color: #fff;
        }

        .input-clinical:focus {
            border-color: #2563eb;
            border-bottom-width: 2px;
            box-shadow: 0 4px 12px -6px #2563eb;
            outline: none;
            background: rgba(15, 23, 42, 0.8);
        }

        /* ----- Buttons ----- */
        .btn-clinical {
            background: #2563eb;
            color: white;
            font-weight: 500;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-clinical:hover {
            background: #1d4ed8;
        }

        .btn-clinical-outline {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.3);
        }

        .btn-clinical-outline:hover {
            background: #2563eb;
            color: white;
        }

        /* ----- Digital Clock ----- */
        .clinical-clock {
            font-family: 'JetBrains Mono', monospace;
            color: #e2e8f0;
        }

        /* ----- Centered Header Layout ----- */
        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        /* ----- Table Styling (dark, clinical) ----- */
        #logsTable {
            width: 100%;
            border-collapse: collapse;
        }

        #logsTable th {
            background: rgba(2, 6, 23, 0.7);
            color: #94a3b8;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        #logsTable td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            color: #e2e8f0;
            font-size: 0.8rem;
        }

        #logsTable tbody tr:hover {
            background: rgba(37, 99, 235, 0.06);
        }

        /* ----- KPI Cards ----- */
        .kpi-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 2px solid rgba(37, 99, 235, 0.3);
        }

        /* ----- Map Container ‚Äì now with light background to match original OSM tiles ----- */
        #map {
            border-radius: 0.5rem;
            background: #f8fafc;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* preserve original status classes (for compatibility) */
        .status-idle {
            color: #94a3b8;
            font-weight: 600;
        }

        .status-enroute {
            color: #d97706;
            font-weight: 600;
        }

        .status-arrived {
            color: #16a34a;
            font-weight: 600;
        }
    </style>
</head>

<body
    class="bg-slate-950 text-slate-200 font-sans antialiased h-screen flex flex-col overflow-hidden relative bg-grid-subtle selection:bg-clinical-blue/30">

    <!-- ========== HEADER ‚Äì CENTERED TITLE, CLINICAL ========= -->
    <header
        class="h-16 border-b border-white/5 bg-slate-950/90 backdrop-blur sticky top-0 z-50 flex-none shadow-md relative flex items-center">
        <div class="max-w-7xl mx-auto px-4 w-full relative flex items-center justify-between">
            <!-- Left: System Status -->
            <div class="flex items-center gap-4 text-xs w-[200px]">
                <div class="flex items-center gap-1.5 bg-slate-800/50 px-3 py-1.5 rounded-full">
                    <i class="fa-solid fa-tower-broadcast text-slate-400"></i>
                    <span class="text-slate-400">AGENT</span>
                    <span class="text-clinical-green font-mono">ACTIVE</span>
                </div>
                <div class="flex items-center gap-1.5 bg-slate-800/50 px-3 py-1.5 rounded-full">
                    <i class="fa-solid fa-ambulance text-slate-400"></i>
                    <span class="text-slate-400">FLEET</span>
                    <span class="text-clinical-blue font-mono">6</span>
                </div>
            </div>

            <!-- Center: Main Heading -->
            <div class="absolute left-1/2 transform -translate-x-1/2 flex flex-col items-center">
                <h1 class="text-lg font-semibold tracking-wide text-white flex items-center gap-2">
                    City‚ÄëWide Ambulance Monitor
                    <span
                        class="text-[10px] font-mono bg-slate-800 px-2 py-0.5 rounded-full text-clinical-blue border border-clinical-blue/30">COMMAND</span>
                </h1>
                <div class="flex items-center gap-3 text-[10px] font-mono text-slate-400">
                    <span class="flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-clinical-green rounded-full"></span>
                        SIMULATION
                    </span>
                    <span class="text-slate-600">|</span>
                    <span class="flex items-center gap-1">
                        <i class="fa-solid fa-heart-pulse text-clinical-blue"></i> LIVE FEED
                    </span>
                </div>
            </div>

            <!-- Right: Clock -->
            <div class="flex flex-col items-end w-[200px]">
                <p class="text-xl font-mono text-white clinical-clock" id="clock">00:00:00</p>
                <p class="text-[9px] text-slate-500 font-mono uppercase">ZULU TIME</p>
            </div>
        </div>
    </header>

    <!-- Main Flex Wrapper -->
    <div class="flex flex-1 overflow-hidden">

        <!-- ========== SIDEBAR ‚Äì CLINICAL DARK ========= -->
        <aside class="w-80 clinical-panel text-slate-200 flex flex-col p-5 overflow-y-auto border-r border-white/5">
            <div class="mb-6">
                <h2 class="text-xs uppercase tracking-wider text-slate-400 font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-sliders-h text-xs text-clinical-blue"></i> Simulation Controls
                </h2>

                <!-- Hospital Selection -->
                <div class="bg-slate-800/30 rounded-xl p-4 mb-5 border border-white/5">
                    <label class="text-xs font-medium text-slate-400 block mb-2 flex items-center gap-1.5">
                        <i class="fas fa-hospital text-clinical-blue"></i> 1. Select Hospital
                    </label>
                    <select id="hospitalSelect" class="input-clinical w-full px-4 py-2.5 text-sm text-white rounded-lg">
                        <option value="" class="bg-slate-800">‚Äî Select Hospital ‚Äî</option>
                    </select>
                </div>

                <!-- Trigger Buttons -->
                <div class="bg-slate-800/30 rounded-xl p-4 mb-5 border border-white/5 space-y-3">
                    <label class="text-xs font-medium text-slate-400 block mb-1 flex items-center gap-1.5">
                        <i class="fas fa-bolt text-clinical-blue"></i> 2. Trigger Scenario
                    </label>
                    <button onclick="triggerFailure()"
                        class="w-full bg-clinical-red/80 hover:bg-clinical-red text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg">
                        <i class="fas fa-fire"></i> Hospital Failure
                    </button>
                    <button onclick="triggerSurge()"
                        class="w-full bg-clinical-amber/80 hover:bg-clinical-amber text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg">
                        <i class="fas fa-exclamation-triangle"></i> Patient Surge (+Load)
                    </button>
                </div>

                <!-- Reset -->
                <div class="bg-slate-800/30 rounded-xl p-4 border border-white/5">
                    <button onclick="resetSimulation()"
                        class="w-full bg-slate-600 hover:bg-clinical-blue text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg">
                        <i class="fas fa-undo-alt"></i> Reset Simulation
                    </button>
                </div>
            </div>

            <!-- Live Stats ‚Äì Sidebar Summary -->
            <div class="mt-auto pt-6 border-t border-white/5">
                <h3 class="text-xs uppercase tracking-wider text-slate-400 font-semibold mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-line text-clinical-blue"></i> System Status
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-400 flex items-center gap-1.5"><i
                                class="fas fa-hospital text-clinical-red"></i> Offline</span>
                        <span id="statOffline"
                            class="font-mono font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full text-xs">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-400 flex items-center gap-1.5"><i
                                class="fas fa-exclamation-circle text-clinical-amber"></i> Overloaded</span>
                        <span id="statOverload"
                            class="font-mono font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full text-xs">0</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ========== MAIN CONTENT (Map + Logs) ========= -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-950/50">

            <!-- KPI Cards ‚Äì clinical style -->
            <div class="flex items-center gap-4 px-6 pt-4 pb-2">
                <div class="kpi-card flex-1 rounded-xl px-5 py-3 flex items-center gap-4">
                    <div class="bg-clinical-red/20 p-2 rounded-full">
                        <i class="fas fa-hospital text-clinical-red text-xl"></i>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400 font-medium">Offline Hospitals</div>
                        <div class="text-2xl font-bold text-white" id="statOffline">0</div>
                    </div>
                </div>
                <div class="kpi-card flex-1 rounded-xl px-5 py-3 flex items-center gap-4">
                    <div class="bg-clinical-amber/20 p-2 rounded-full">
                        <i class="fas fa-tachometer-alt text-clinical-amber text-xl"></i>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400 font-medium">Overloaded</div>
                        <div class="text-2xl font-bold text-white" id="statOverload">0</div>
                    </div>
                </div>
            </div>

            <!-- MAP CONTAINER ‚Äì clinical glass, but now with light OSM tiles -->
            <div id="map-container"
                class="flex-1 relative mx-6 mb-3 rounded-2xl overflow-hidden clinical-panel border border-white/5">
                <div id="map" class="h-full w-full"></div>

                <!-- Legend ‚Äì Glass card -->
                <div
                    class="absolute bottom-4 right-4 bg-slate-900/80 backdrop-blur-md rounded-xl shadow-xl p-4 text-xs border border-white/10 z-[1000]">
                    <h4 class="font-semibold text-slate-300 mb-2 flex items-center gap-1.5"><i
                            class="fas fa-map-signs text-clinical-blue"></i> Map Legend</h4>
                    <div class="space-y-1.5">
                        <div><span class="inline-block w-2.5 h-2.5 rounded-full bg-clinical-green mr-2"></span> Hospital
                            (Normal)</div>
                        <div><span class="inline-block w-2.5 h-2.5 rounded-full bg-clinical-amber mr-2"></span> Hospital
                            (High Load)</div>
                        <div><span class="inline-block w-2.5 h-2.5 rounded-full bg-clinical-red mr-2"></span> Hospital
                            (Offline)</div>
                        <div><span class="inline-block w-2.5 h-2.5 rounded-full bg-blue-500 mr-2"></span> Ambulance
                            (Idle)</div>
                        <div><span class="inline-block w-2.5 h-2.5 rounded-full bg-indigo-500 mr-2"></span> Ambulance
                            (Enroute)</div>
                    </div>
                </div>
            </div>

            <!-- LOGS ‚Äì Clinical data grid -->
            <div id="logs-container" class="clinical-panel border-t border-white/5 flex flex-col shadow-inner"
                style="height: 30%;">
                <div class="px-6 py-3 bg-slate-900/50 border-b border-white/5 flex items-center justify-between">
                    <h2 class="text-xs font-semibold uppercase tracking-wider text-slate-400 flex items-center gap-2">
                        <i class="fas fa-list-ul text-clinical-blue"></i> Live Decision Logs (Read‚ÄëOnly)
                    </h2>
                    <span class="text-xs text-slate-500"><i class="far fa-clock mr-1"></i> latest first</span>
                </div>
                <div class="overflow-y-auto flex-1">
                    <table id="logsTable" class="w-full text-sm border-collapse">
                        <thead class="bg-slate-950/70 sticky top-0 z-10">
                            <tr class="text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
                                <th class="px-6 py-3">Time</th>
                                <th class="px-6 py-3">Ambulance ID</th>
                                <th class="px-6 py-3">Destination Hospital</th>
                                <th class="px-6 py-3">Reason Summary</th>
                                <th class="px-6 py-3">Distance / ETA</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== 100% ORIGINAL JAVASCRIPT LOGIC (PRESERVED) ========== -->
    <script>
        // ---------- üöë ORIGINAL ADMIN LOGIC ‚Äì DO NOT MODIFY (only CSS class names updated for message styling) ----------
        // Configuration
        const API_BASE = 'http://localhost:3000';

        // Map State
        let map;
        let hospitalMarkers = {};
        let ambulanceMarkers = {};
        let ambulanceRoutes = {};
        let hospitalsData = [];
        let hospitalStates = {};

        const AMBULANCE_COUNT = 6;
        const AMBULANCES = [];

        // Icons (preserved)
        const hospitalIconNormal = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/4320/4320371.png',
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
        });

        const hospitalIconWarning = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/564/564619.png',
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
        });

        const hospitalIconError = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1828/1828843.png',
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
        });

        const ambulanceIconIdle = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/263/263058.png',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // Initialize Map ‚Äì using original OpenStreetMap tiles (light theme)
        async function initMap() {
            map = L.map('map').setView([17.40, 78.47], 12);
            // Original OSM tiles ‚Äì no dark theme
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            await fetchHospitals();
            initAmbulances();

            setInterval(updateHospitalStates, 2000);
            setInterval(updateAmbulances, 1000);
            setInterval(generateDecision, 5000);
        }

        async function fetchHospitals() {
            try {
                const res = await fetch(`${API_BASE}/hospitals`);
                hospitalsData = await res.json();

                const select = document.getElementById('hospitalSelect');
                hospitalsData.forEach(h => {
                    const marker = L.marker([h.latitude, h.longitude], { icon: hospitalIconNormal })
                        .addTo(map)
                        .bindPopup(`<b>${h.name}</b><br>ID: ${h.hospital_id}`);
                    hospitalMarkers[h.hospital_id] = marker;

                    const opt = document.createElement('option');
                    opt.value = h.hospital_id;
                    opt.textContent = h.name;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error("Error fetching hospitals:", err);
            }
        }

        async function updateHospitalStates() {
            try {
                const res = await fetch(`${API_BASE}/hospitals/state/all`);
                hospitalStates = await res.json();

                let offlineCount = 0;
                let overloadCount = 0;

                Object.values(hospitalStates).forEach(state => {
                    const marker = hospitalMarkers[state.hospital_id];
                    if (!marker) return;

                    let icon = hospitalIconNormal;
                    let popupText = `<b>${state.name || 'Hospital'}</b><br>
                                     Beds: ${state.available_beds}<br>
                                     Load: ${state.current_load_score}<br>
                                     Status: ${state.status}`;

                    if (state.status === 'OFFLINE') {
                        icon = hospitalIconError;
                        offlineCount++;
                    } else if (state.current_load_score >= 80 || state.available_beds == 0) {
                        icon = hospitalIconWarning;
                        overloadCount++;
                    }

                    marker.setIcon(icon);
                    marker.setPopupContent(popupText);
                });

                // Update both sidebar and KPI cards
                document.querySelectorAll('#statOffline').forEach(el => el.textContent = offlineCount);
                document.querySelectorAll('#statOverload').forEach(el => el.textContent = overloadCount);

            } catch (err) {
                console.error("Error updating states:", err);
            }
        }

        async function triggerFailure() {
            const hospitalId = document.getElementById('hospitalSelect').value;
            if (!hospitalId) return alert("Select a hospital first!");

            await fetch(`${API_BASE}/simulation/override`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    hospital_id: hospitalId,
                    status: 'OFFLINE',
                    available_beds: 0,
                    available_icu_beds: 0
                })
            });
        }

        async function triggerSurge() {
            const hospitalId = document.getElementById('hospitalSelect').value;
            if (!hospitalId) return alert("Select a hospital for surge!");

            await fetch(`${API_BASE}/simulation/override`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    hospital_id: hospitalId,
                    current_load_score: 90
                })
            });
        }

        async function resetSimulation() {
            await fetch(`${API_BASE}/simulation/reset`, { method: 'POST' });
        }

        function initAmbulances() {
            for (let i = 0; i < AMBULANCE_COUNT; i++) {
                const lat = 17.38 + (Math.random() - 0.5) * 0.1;
                const lng = 78.48 + (Math.random() - 0.5) * 0.1;

                AMBULANCES.push({
                    id: `AMB-${100 + i}`,
                    lat: lat,
                    lng: lng,
                    status: 'IDLE',
                    destination: null,
                    progress: 0,
                    routePath: null
                });

                const marker = L.marker([lat, lng], { icon: ambulanceIconIdle }).addTo(map)
                    .bindPopup(`<b>${AMBULANCES[i].id}</b><br>Status: IDLE`);
                ambulanceMarkers[AMBULANCES[i].id] = marker;
            }
        }

        function updateAmbulances() {
            AMBULANCES.forEach(amb => {
                if (amb.status === 'ENROUTE' && amb.routePath) {
                    if (amb.progress < amb.routePath.length - 1) {
                        amb.progress++;
                        const newPos = amb.routePath[amb.progress];
                        amb.lat = newPos[0];
                        amb.lng = newPos[1];

                        if (ambulanceMarkers[amb.id]) {
                            ambulanceMarkers[amb.id].setLatLng([amb.lat, amb.lng]);
                        }

                        // Update route to vanish travelled path
                        if (ambulanceRoutes[amb.id]) {
                            const remaining = amb.routePath.slice(amb.progress);
                            ambulanceRoutes[amb.id].setLatLngs(remaining);
                        }
                    } else {
                        amb.status = 'IDLE';
                        amb.destination = null;
                        amb.routePath = null;
                        amb.progress = 0;

                        if (ambulanceRoutes[amb.id]) {
                            map.removeLayer(ambulanceRoutes[amb.id]);
                            delete ambulanceRoutes[amb.id];
                        }
                        if (ambulanceMarkers[amb.id]) {
                            ambulanceMarkers[amb.id].setPopupContent(`<b>${amb.id}</b><br>Status: IDLE`);
                        }
                    }
                }
            });
        }

        async function generateDecision() {
            const idleAmbulances = AMBULANCES.filter(a => a.status === 'IDLE');
            if (idleAmbulances.length === 0) return;

            const amb = idleAmbulances[Math.floor(Math.random() * idleAmbulances.length)];

            try {
                const payload = {
                    request_id: "sim-" + Date.now(),
                    ambulance: {
                        ambulance_id: amb.id,
                        latitude: amb.lat,
                        longitude: amb.lng
                    },
                    patient: {
                        age: 30,
                        gender: 'M',
                        severity_level: 3,
                        requires_icu: Math.random() > 0.7,
                        symptoms_summary: "Simulated Case"
                    },
                    constraints: {
                        max_distance_km: 20,
                        max_results: 1
                    }
                };

                const res = await fetch(`${API_BASE}/agent/decide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const decision = await res.json();

                if (decision.recommendations && decision.recommendations.length > 0) {
                    const rec = decision.recommendations[0];
                    const targetState = hospitalStates[rec.hospital_id];
                    const targetStatic = hospitalsData.find(h => h.hospital_id === rec.hospital_id);
                    const target = targetState || targetStatic;

                    if (!target) return;

                    amb.status = 'ENROUTE';
                    amb.destination = target;

                    const routeRes = await fetch(`https://router.project-osrm.org/route/v1/driving/${amb.lng},${amb.lat};${target.longitude},${target.latitude}?overview=full&geometries=geojson`);
                    const routeData = await routeRes.json();

                    if (routeData.routes && routeData.routes.length > 0) {
                        const route = routeData.routes[0];
                        amb.routePath = route.geometry.coordinates.map(c => [c[1], c[0]]);

                        // Use L.polyline instead of L.geoJSON for dynamic updating
                        const polyline = L.polyline(amb.routePath, { color: '#2563eb', weight: 4, opacity: 0.7 }).addTo(map);
                        ambulanceRoutes[amb.id] = polyline;

                        addLog(amb.id, target.name, route.distance, route.duration, rec.reasons || ["Decision Engine"]);
                    }
                }
            } catch (e) {
                console.error("Simulation Decision Failed", e);
            }
        }

        function addLog(ambId, hospitalName, distanceMeters, durationSeconds, reasons) {
            const tableBody = document.querySelector('#logsTable tbody');
            const row = document.createElement('tr');

            const distKm = (distanceMeters / 1000).toFixed(1);
            const etaMin = Math.round(durationSeconds / 60);

            row.innerHTML = `
                <td class="px-6 py-3 font-mono text-xs text-slate-400">${new Date().toLocaleTimeString()}</td>
                <td class="px-6 py-3 font-medium text-white">${ambId}</td>
                <td class="px-6 py-3 text-slate-300">${hospitalName}</td>
                <td class="px-6 py-3 text-xs text-slate-400">${reasons.join(", ")}</td>
                <td class="px-6 py-3 font-mono text-sm font-semibold text-clinical-blue">${distKm} km / ${etaMin} min</td>
            `;

            tableBody.insertBefore(row, tableBody.firstChild);
            if (tableBody.children.length > 10) tableBody.removeChild(tableBody.lastChild);
        }

        window.onload = initMap;
    </script>

    <!-- ========== ENHANCEMENT LAYER (Clock) ‚Äì ADDITIVE, NON‚ÄëINTRUSIVE ========== -->
    <script>
        // ---------- ‚è∞ DIGITAL CLOCK ----------
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>

</html>